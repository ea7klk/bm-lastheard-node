<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
    }
    table {
      width: 80%;
      margin: 0 auto;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid black;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .filter-container {
      margin-bottom: 20px;
    }
    .filter-container select {
      padding: 5px;
      margin: 0 10px;
    }
  </style>
</head>
<body>
  <h1>Dashboard</h1>
  <div class="filter-container">
    <label for="time-range">Time Range:</label>
    <select id="time-range" onchange="fetchDashboardData()">
      <option value="last-15-minutes">Last 15 Minutes</option>
      <option value="last-30-minutes">Last 30 Minutes</option>
      <option value="last-hour">Last Hour</option>
      <option value="last-6-hours">Last 6 Hours</option>
      <option value="last-12-hours">Last 12 Hours</option>
      <option value="today">Today</option>
      <option value="last-24-hours">Last 24 Hours</option>
      <option value="this-week">This Week</option>
      <option value="last-7-days">Last 7 Days</option>
      <option value="this-month">This Month</option>
      <option value="last-month">Last Month</option>
      <option value="all">All</option>
    </select>
  </div>
  <h2>Total Record Count: <span id="record-count">Loading...</span></h2>
  <h2>Top 20 Destination TGs for EA (Spain)</h2>
  <table>
    <thead>
      <tr>
        <th>TG Number</th>
        <th>TG Name</th>
        <th>Count</th>
        <th>Percentage</th>
        <th>Total QSO Duration</th>
      </tr>
    </thead>
    <tbody id="top-DestinationIDs">
      <!-- Data will be inserted here -->
    </tbody>
  </table>

  <script>
    async function fetchDashboardData() {
      const timeRange = document.getElementById('time-range').value;

      const queryParams = new URLSearchParams();
      queryParams.append('range', timeRange);

      try {
        const [recordCountResponse, topDestinationIDsResponse] = await Promise.all([
          fetch(`/record-count-range-ea?${queryParams.toString()}`),
          fetch(`/top-destination-rangeEA?${queryParams.toString()}`)
        ]);

        const recordCountData = await recordCountResponse.json();
        const topDestinationIDsData = await topDestinationIDsResponse.json();

        document.getElementById('record-count').textContent = recordCountData.count;

        const topDestinationIDsTable = document.getElementById('top-DestinationIDs');
        topDestinationIDsTable.innerHTML = '';

        topDestinationIDsData.forEach(DestinationID => {
          const percentage = ((DestinationID.count / recordCountData.count) * 100).toFixed(2);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${DestinationID.DestinationID}</td>
            <td>${DestinationID.DestinationName}</td>
            <td>${DestinationID.count}</td>
            <td>${percentage}%</td>
            <td>${DestinationID.totalDuration} sec.</td>
          `;
          topDestinationIDsTable.appendChild(row);
        });
      } catch (error) {
        console.error('Error fetching dashboard data:', error);
      }
    }

    // Fetch dashboard data on page load
    fetchDashboardData();

    // Refresh the page every 5 seconds
    setInterval(fetchDashboardData, 5000);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Pie Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
    }
    .filter-container {
      margin-bottom: 20px;
    }
    .filter-container select {
      padding: 5px;
      margin: 0 10px;
    }
    canvas {
      max-width: 600px;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <h1>Dashboard - Pie Chart</h1>
  <div class="filter-container">
    <label for="time-range">Time Range:</label>
    <select id="time-range" onchange="fetchDashboardData()">
      <option value="last-15-minutes">Last 15 Minutes</option>
      <option value="last-30-minutes">Last 30 Minutes</option>
      <option value="last-hour">Last Hour</option>
      <option value="last-6-hours">Last 6 Hours</option>
      <option value="last-12-hours">Last 12 Hours</option>
      <option value="today">Today</option>
      <option value="last-24-hours">Last 24 Hours</option>
      <option value="this-week">This Week</option>
      <option value="last-7-days">Last 7 Days</option>
      <option value="all">All</option>
    </select>
    <label for="country-selector">Select Country:</label>
    <select id="country-selector" onchange="fetchDashboardData()">
        <option value="All" selected> All</option>
        <option value="AT">Austria</option>
        <option value="BE">Belgium</option>
        <option value="BG">Bulgaria</option>
        <option value="CY">Cyprus</option>
        <option value="CZ">Czech Republic</option>
        <option value="DE">Germany</option>
        <option value="DK">Denmark</option>
        <option value="EE">Estonia</option>
        <option value="ES">Spain</option>
        <option value="FI">Finland</option>
        <option value="FR">France</option>        
        <option value="GR">Greece</option>
        <option value="HR">Croatia</option>
        <option value="HU">Hungary</option>
        <option value="IE">Ireland</option>
        <option value="IT">Italy</option>
        <option value="LT">Lithuania</option>
        <option value="LU">Luxembourg</option>
        <option value="LV">Latvia</option>
        <option value="MT">Malta</option>
        <option value="NL">Netherlands</option>
        <option value="PL">Poland</option>
        <option value="PT">Portugal</option>
        <option value="RO">Romania</option>
        <option value="SE">Sweden</option>
        <option value="SI">Slovenia</option>
        <option value="SK">Slovakia</option>
        <option value="UK">United Kingdom</option>
    </select>
  </div>
  <h2>Total Record Count: <span id="record-count">Loading...</span></h2>
  <canvas id="myPieChart"></canvas>

  <script>
    let myPieChart;

    async function fetchDashboardData() {
      const timeRange = document.getElementById('time-range').value;
      const country = document.getElementById('country-selector').value;

      const queryParams = new URLSearchParams();
      queryParams.append('range', timeRange);
      queryParams.append('country', country);

      try {
        const response = await fetch(`/top-destination-range-country?${queryParams.toString()}`);
        const topDestinationIDsData = await response.json();

        const recordCountResponse = await fetch(`/record-count-range-country?${queryParams.toString()}`);
        const recordCountData = await recordCountResponse.json();
        document.getElementById('record-count').textContent = recordCountData.count;

        const labels = topDestinationIDsData.map(DestinationID => `${DestinationID.DestinationName} (${DestinationID.DestinationID})`);
        const data = topDestinationIDsData.map(DestinationID => DestinationID.count);
        const totalCount = recordCountData.count;
        const percentages = data.map(count => ((count / totalCount) * 100).toFixed(2));

        const ctx = document.getElementById('myPieChart').getContext('2d');

        if (myPieChart) {
          myPieChart.destroy(); // Destroy the previous chart instance
        }

        myPieChart = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)',
                'rgba(255, 159, 64, 0.6)',
              ],
              borderColor: 'rgba(255, 255, 255, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: true,
                position: 'top',
              },
              tooltip: {
                callbacks: {
                  label: function(tooltipItem) {
                    const percentage = percentages[tooltipItem.dataIndex];
                    return `${tooltipItem.label}: ${percentage}%`;
                  }
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error fetching dashboard data:', error);
      }
    }

    // Fetch dashboard data on page load
    fetchDashboardData();

    // Refresh the data every 5 seconds
    setInterval(fetchDashboardData, 5000);
  </script>
</body>
</html>
